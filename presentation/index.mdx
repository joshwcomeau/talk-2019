import { Cite } from 'spectacle'
import CodeSlide from 'spectacle-code-slide'

import { LightSlide } from './slides'
import RegularComponent from './regular-component'
import TitleCard from '../src/components/TitleCard'
import PoppingCircle from '../src/components/PoppingCircle'
import Spacer from '../src/components/Spacer'
import SpacedRow from '../src/components/SpacedRow'
import Avatar from '../src/components/Avatar'
import Footnote from '../src/components/Footnote'
import AnimationIntroScreen from '../src/components/AnimationIntroScreen'
import ExternalLink from '../src/components/ExternalLink'
import FlexRow from '../src/components/FlexRow'
import BigNumber from '../src/components/BigNumber'

import './index.css'

# üëãüèª Good morning!

---

My name‚Äôs Josh.

I flew here from Canada.

# üõ´

---

Raise your hand if you flew here as well

‚úã

---

Keep your hand raised if you enjoyed your flight

---

Flying is **amazing**

---

import flying1 from '../assets/flying-1.jpg'

<img src={flying1} style={{ width: '100%' }} />

---

import flying2 from '../assets/flying-2.jpg'

<img src={flying2} style={{ width: '100%' }} />

---

import flying3 from '../assets/flying-3.jpg'

<img src={flying3} style={{ width: '100%' }} />

---

...but it doesn't always feel amazing.

---

Let's talk about

### Boarding

---

import boardRankedSrc from '../assets/plane-boarding-methods-ranked.png'

<img src={boardRankedSrc} style={{ width: '100%' }} />

---

import boardStupidSrc from '../assets/plane-boarding-stupid.png'

<img src={boardStupidSrc} style={{ width: '100%' }} />

---

import boardBusinessSrc from '../assets/board-business.png'

<img src={boardBusinessSrc} style={{ width: '100%' }} />

export default LightSlide

---

import mythbustersSrc from '../assets/mythbusters.mp4'

<video autoPlay src={mythbustersSrc} style={{ width: '100%' }} />

---

Boarding is indeed important...

---

...But is boarding _really_ the biggest problem with air travel?

---

What does this have to do with anything?

---

# Performance

---

### Things we optimize for performance:

- Client-side routing
- Server-side rendering
- Code-splitting
- Tree-shaking
- Lazy-loading

---

### Things we don't think about so much:

- Everything after the page loads

---

import pieSrc from '../assets/pie-opaque.png'

export default LightSlide

<img src={pieSrc} style={{ width: '100%' }} />

---

<TitleCard />

---

How did we get here?

---

import amazonArticle from '../assets/amazon-article.png'

<img src={amazonArticle} style={{ width: '100%' }} />

<Footnote
  subtitle="Source: fastcompany.com"
  href="https://www.fastcompany.com/1825005/how-one-second-could-cost-amazon-16-billion-sales"
/>

---

import slowLoading from '../assets/slow-loading.jpg'

<img src={slowLoading} style={{ width: '100%' }} />

---

import amazonArticle2 from '../assets/amazon-article-pt2.png'

<ExternalLink href="https://www.gigaspaces.com/blog/amazon-found-every-100ms-of-latency-cost-them-1-in-sales/">
  <img src={amazonArticle2} style={{ height: '100%' }} />
</ExternalLink>

---

import mansplaining from '../assets/mansplaining.png'

<img src={mansplaining} style={{ height: '100%' }} />

---

import acSearchResults from '../assets/ac-search-results.png'

<img src={acSearchResults} style={{ width: '100%' }} />

---

### Humans are impatient

---

### Pop Quiz

Do you think we become <em>more</em> or <em>less</em> patient after the initial page load?

---

<FlexRow>
  <BigNumber
    num="100ms"
    description="time to transition UI when clicking or tapping"
  />
  <BigNumber num="16ms" description="time for each frame in an animation" />
</FlexRow>

---

import inputDelaySrc from '../assets/input-delay.mp4'

<ExternalLink href="https://input-delay.glitch.me/">
  <video autoPlay src={inputDelaySrc} style={{ height: '100%' }} />
</ExternalLink>

<Footnote
  title="input-delay.glitch.me"
  subtitle="Made by Monica Dinculescu"
  href="https://input-delay.glitch.me/"
/>

---

Staring at a white screen is bad.

Having noticeable feedback delay is worse!

---

<AnimationIntroScreen prefix="Case Study" title="EMT Software" />

---

import pcrSrc from '../assets/patient-care-report.png'

<img src={pcrSrc} style={{ width: '100%' }} />

<Footnote
  title={'"Performance Matters"'}
  subtitle="Hillel Wayne"
  href="https://www.hillelwayne.com/post/performance-matters"
/>

---

- 30,000,000 PCRs filled out per year, many by hand
- Written in emergency situations, in-ambulance
- Mistakes can be fatal (did they write 100mg or 160mg?)

---

A software version exists, and it's better in every measurable way, but nobody uses it.

---

The machine it runs on is low-powered, and every input comes with a 250ms delay.

---

Nobody wants to use software with noticeable input lag.

---

<ExternalLink href="https://www.hillelwayne.com/post/performance-matters">
  hillelwayne.com/post/performance-matters
</ExternalLink>

---

# Fixing input lag

- Spot the problem with React DevTools
- Avoid unnecessary renders with _React.memo()_
- Move complex work off of the main thread.
- Prioritize updates with React Fiber\*

<br />
<br />

\* Still unstable I think?

---

There are resources for this stuff üéâ

---

# What about animations?

---

When applied tastefully, animations provide important visual context and
feedback. Animations can make your UI feel tangible.

---

A janky animation breaks the illusion, and the dissonance is uncomfortable.

---

Effectively, there are 3 categories of performance:

1. Initial load performance
2. Input feedback performance
3. Animation performance

---

# Native Mobile vs. Web

---

### 1. Initial Load Performance

Web apps take a couple seconds to load, and can be accessed instantly.

<div
  style={{ color: 'white', fontSize: 22, fontFamily: "'Merriweather',serif" }}
>
  Mobile apps require navigating the App Store, finding the app, checking your
  password manager to figure out what your iCloud password is, downloading an
  enormous file, installing it, deal with permissions, swipe through your home
  screens to find the app, and open it.
</div>

**Winner: üï∏Ô∏è**

---

## Question

Guess how large the Facebook mobile app is?

---

export default LightSlide

import facebookAppSize from '../assets/fb-app-size.jpg'

<img src={facebookAppSize} style={{ height: '100vh' }} />

---

import mario64Src from '../assets/super-mario-64.jpg'

<img src={mario64Src} style={{ width: '50%' }} />

Mario 64 was 32 megabytes.

---

### 2. Input Feedback Performance

Mobile apps are solid. Generally, web apps are pretty alright as well, at least on modern hardware in North America.

**Winner: Draw**

---

### 3. Animation Performance

Even on powerful hardware, many web apps don't have 60fps animations (if they have any at all).

Mobile apps tend to be butter-smooth and delightful.

**Winner: üì±**

---

People put up with the high onboarding friction of mobile because the _user experience_ is better.

---

import mattPerryDevSrc from '../assets/matt-perry-dev.jpg'
import chantasticSrc from '../assets/chantastic.jpg'

<SpacedRow>
  <Avatar name="Matt G Perry" src={mattPerryDevSrc} />
  <Avatar name="Chantastic" src={chantasticSrc} />
</SpacedRow>

<Footnote
  title="React Podcast #35"
  subtitle="Make the Web Look Great, with Matt Perry"
  href="https://reactpodcast.simplecast.fm/35"
/>

---

# Relevance

<!-- Matt Perry's ideas about the web as a uniquely open platform -->

---

The web is an amazing open platform.

---

import codesandboxNetlifySrc from '../assets/codesandbox-netlify.jpg'

<img src={codesandboxNetlifySrc} style={{ width: '100%' }} />

---

import webflowSrc from '../assets/webflow.mp4'

<video autoPlay src={webflowSrc} style={{ width: '100%' }} />

---

The web is _low-friction_ both for consumers and developers.

The web is content-rich because of it.

---

In order to keep the web relevant, we need to create native-mobile-quality experiences.

---

<AnimationIntroScreen title="Accordions" />

---

<!--

- Go to the bootstrap accordion demo, show how it works
- Pull up the devtools
- Record opening and closing
- Explain the FPS count - ideally we want 60fps. This is the native refresh rate of a lot of devices, and it's also just a buttery target.
- 60fps -> 16.6ms/frame
- zoom into a slower frame
- Focus on layout and paint
- Show how the ENTIRE PAGE is being repainted
-->

[Bootstrap Accordion example](https://getbootstrap.com/docs/4.0/components/collapse/#accordion-example)

---

import greenPixelsSrc from '../assets/green-pixels.mp4'

The Pixel Pipeline

<video
  src={greenPixelsSrc}
  autoPlay
  loop
  style={{ width: 300, height: 300, borderRadius: 1000, objectFit: 'cover' }}
/>

---

import pixelPipelineSrc from '../assets/pixel-pipeline.jpg'

export default LightSlide

<img src={pixelPipelineSrc} style={{ width: '100%' }} />

<br /><br /><br />

<div style={{ fontSize: 15 }}>
  Courtesy of{' '}
  <a href="https://developers.google.com/web/fundamentals/performance/rendering/">
    Google Web Fundamentals docs
  </a>
  .
</div>

---

Properties like `background-color` don't trigger layout.

---

import cssTriggersSrc from '../assets/csstriggers.png'

<img src={cssTriggersSrc} style={{ width: '100%' }} />

[https://csstriggers.com/](https://csstriggers.com/)

---

We should rely primarily on two properties that can skip layout _and_ paint:

`opacity` and `transform`

---

# A better accordion?

---

We can't build _exactly_ that animation, but we can build something close.

---

import AccordionExample from '../src/components/Accordion/Accordion.example'

<AccordionExample />

---

export default props => (
  <CodeSlide
    {...props}
    lang="jsx"
    code={require('raw-loader!./code/accordion.item.with-mounting.example')}
    ranges={[
      { loc: [0], title: 'Accordion Item' },
      { loc: [8, 9] },
      { loc: [9, 13] },
      { loc: [21, 27] },
      { loc: [31, 38] },
      { loc: [47, 48] },
      { loc: [38, 46] },
      { loc: [50, 60] },
    ]}
  />
)

---

export default props => (
  <CodeSlide
    {...props}
    lang="jsx"
    code={require('raw-loader!./code/accordion.item.without-mounting.example')}
    ranges={[{ loc: [50, 67] }, { loc: [55, 67] }, { loc: [67, 76] }]}
  />
)

---

# Don't be afraid to break the rules\*

\*As long as you're profiling!

---

import khanMenu from '../assets/khan-menu.gif'

<img src={khanMenu} />

---

<AnimationIntroScreen title="Like Button" />

---

import Tweet from '../src/components/Tweet/Tweet.managed'

<SpacedRow>
  <Tweet tweetContents="Hello React Europe! üëãüèª" />
</SpacedRow>

---

import LikeButton from '../src/components/LikeButton/LikeButton.managed'

<LikeButton size={160} />

---

export default props => (
  <CodeSlide
    {...props}
    lang="js"
    code={require('raw-loader!./code/particle-api.example')}
    ranges={[
      { loc: [0], title: 'Particle usage' },
      { loc: [0, 4] },
      { loc: [4, 5] },
    ]}
  />
)

---

# Trigonometry!

[jspaint.app](https://jspaint.app)

<!-- soh-cah-toa, figuring out angle and distance -->

---

export default props => (
  <CodeSlide
    {...props}
    lang="jsx"
    code={require('raw-loader!./code/particle.example')}
    ranges={[
      { loc: [0], title: 'Particle.js' },
      { loc: [2, 7] },
      { loc: [7, 9] },
      { loc: [10, 14] },
      { loc: [15, 21] },
      { loc: [22, 27] },
    ]}
  />
)

---

...wait this is a performance talk

---

import likeBeforeSrc from '../assets/like-before.png'

<img src={likeBeforeSrc} style={{ width: '100%' }} />

---

## Also, this animation runs on the main thread.

[Perf test](https://codepen.io/joshwcomeau/pen/yrPzWO)

---

# Options

- Less particles
- Use CSS transitions
- Sprites

---

import likeSpriteSrc from '../assets/like-sprite.png'

export default LightSlide

<img src={likeSpriteSrc} style={{ width: '100%' }} />

---

import LikeSprite from '../src/components/LikeSprite'

export default LightSlide

<LikeSprite />

---

export default props => (
  <CodeSlide
    {...props}
    lang="jsx"
    code={require('raw-loader!./code/like-sprite.example')}
    ranges={[
      { loc: [0], title: 'LikeSprite.js' },
      { loc: [5, 12] },
      { loc: [13, 18] },
      { loc: [19, 24] },
      { loc: [25, 33] },
    ]}
  />
)

---

# The performance

Near-free. Takes a few microseconds per tick.

---

# Tools

- [GIPHY Capture](https://giphy.com/apps/giphycapture)
- [EZGif](https://ezgif.com/gif-to-sprite)
- Photoshop (or similar)

---

<AnimationIntroScreen title="Offscreen Canvas" />

---

# So I built a thing

[Tinkersynth](https://tinkersynth.com)

<!--

show off the product.

Talk about the expensiveness of calculating every line

Mention trigonometry, when showing the polar control

-->

---

# Web Workers

We can do all of the art calculations in a worker.

Workers don't have access to the DOM, though, so painting to canvas is still really slow.

---

# OffscreenCanvas

OffscreenCanvas allows you to _paint to a canvas_ from _within a web worker_.

---

import tinkersynthYikesSrc from '../assets/tinkersynth-yikes.mp4'

<video autoPlay loop src={tinkersynthYikesSrc} style={{ width: '100%' }} />

---

# Conclusion

---

## People hate waiting seconds for a page to load

---

## People hate waiting tenths of seconds for feedback for their actions

---

## People hate waiting hundredths of seconds for each frame in an animation

---

The problems are similar, but the solutions are very different.

It's worth learning the "full stack" of front-end web performance.

---

Thank you!

All code samples available through Twitter:

<span style={{ fontSize: 72, color: '#6FA0FF' }}>{'@JoshWComeau'}</span>
